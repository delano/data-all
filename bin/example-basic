#!/usr/bin/env perl

use FindBin;

use lib $FindBin::Bin . '/../lib';

use File::Spec;
use Data::Dumper;

use Class::Factory;
use Data::All;

#   Create an instance of Data::All for database data
my $input1 = Data::All->new(
    source => { path => [$FindBin::Bin, '/../t/sample.csv'], profile => 'csv' },
    target   => { path => $FindBin::Bin . '/../t/sample.tab',  profile => 'tab', ioconf  => ['file', 'w']}
);

#   $rec now contains an arrayref of hashrefs for the data defined in %db.
my $rec  = $input1->convert(print_fields => 1);

print Dumper($rec);

my %in2 = (
	path	=> $FindBin::Bin . '/../t/sample.csv',
	profile => 'csv',
	ioconf  => ['file', 'r']
);

my %out2 = (
        path    => $FindBin::Bin . '/../t/sample.fixed',
        format	=> ['fixed', "\n", [16,4,32,32]],
        ioconf  => ['file', 'w']
);

my $dsn1     = 'DBI:mysql:database=DELANOTES;host=localhost;';
my $dsn2     = 'DBI:Pg:database=SOMEOTHERDB;host=YOURHOST;';
my $query1   = 'SELECT `date_summarized`, `title`, `uri` FROM delanotes_summaries';
my $query2   = 'INSERT INTO users (`Password`, `User`, `Host`) VALUES(?,?,?)';

my %db_r = 
(   path        => [$dsn1, 'root', '1212', $query1],
    ioconf      => ['db', 'r']
);

# This doesn't work yet:
#my $delanotes_out = [$FindBin::Bin . '/../t/delanotes.csv', 'csv', 'w'];
my %delanotes_out = (
	path	=> $FindBin::Bin . '/../t/delanotes.csv',
	profile => 'csv',
	ioconf  => ['file', 'w']
	);
	
#my $da = Data::All->new(source =>\%in2, target => \%out2);
#my $da = Data::All->new(source =>\%db_r, target => \%delanotes_out);
#$da->convert();








__DATA__
my $x=File::Spec->catfile('a', 'b', 'c');
my ($volume,$directories,$file) = File::Spec->splitpath( $x, 1 );

my $in1  = [$FindBin::Bin . '/../t/sample.csv', 'csv', 'r'];
my $out1 = [$FindBin::Bin . '/../t/sample.fixed', [16,4,32,32], 'w'];


my $dsn1     = 'DBI:mysql:database=DELANOTES;host=localhost;';
my $dsn2     = 'DBI:Pg:database=SOMEOTHERDB;host=YOURHOST;';
my $query1   = 'SELECT `date_summarized`, `title`, `uri` FROM delanotes_summaries';
my $query2   = 'INSERT INTO users (`Password`, `User`, `Host`) VALUES(?,?,?)';

my %db_r = 
(   path        => [$dsn1, 'user', 'pass', $query1],
    ioconf      => ['db', 'r']
);

my $delanotes_out = [$FindBin::Bin . '/../t/delanotes.csv', 'csv', 'w'];

my %db_w = 
(   path        => [$dsn2, 'user', 'pass', $query2],
    ioconf      => { 
		type => 'db', 
		perms => 'w' 
	},
    fields      => ['Password', 'User', 'Host']
);



my $da = Data::All->new(from =>\%infile, to=> \%outfile);

$da->open();

my $rec = $da->read();

ok($#{ $rec } == 2, "Check record count");
ok(exists($rec->[0]->{'name'}), "Check field names");

$da->convert();

ok(1);